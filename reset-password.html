<!DOCTYPE html>
<html class="no-js" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="description" content="Reset your password." />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <!-- The above 4 meta tags *must* come first in the head; any other head content must come *after* these tags -->

    <!-- Title  -->
    <title>Reset Password - Hereditas</title>

    <!-- Favicon  -->
    <link rel="icon" href="assets/img/favicon.png" />

    <!-- ***** All CSS Files ***** -->

    <!-- Style css -->
    <link rel="stylesheet" href="assets/css/style.css" />
  </head>

  <body>
    <div class="main">
      <!-- ***** Preloader Start ***** -->
      <div class="preloader-main">
        <div class="preloader-wapper">
          <svg
            class="preloader"
            xmlns="http://www.w3.org/2000/svg"
            version="1.1"
            width="600"
            height="200"
          >
            <defs>
              <filter id="goo" x="-40%" y="-40%" height="200%" width="400%">
                <feGaussianBlur
                  in="SourceGraphic"
                  stdDeviation="10"
                  result="blur"
                />
                <feColorMatrix
                  in="blur"
                  mode="matrix"
                  values="1 0 0 0 0  0 1 0 0 0  0 0 1 0 0  0 0 0 19 -8"
                  result="goo"
                />
              </filter>
            </defs>
            <g filter="url(#goo)">
              <circle class="dot" cx="50" cy="50" r="25" fill="#203d52" />
              <circle class="dot" cx="50" cy="50" r="25" fill="#203d52" />
            </g>
          </svg>
          <div>
            <div class="loader-section section-left"></div>
            <div class="loader-section section-right"></div>
          </div>
        </div>
      </div>
      <!-- ***** Preloader End ***** -->

      <!-- ***** Header Start ***** -->
      <header id="header">
        <!-- Navbar -->
        <nav
          data-aos="zoom-out"
          data-aos-delay="800"
          class="navbar gameon-navbar navbar-expand"
        >
          <div class="container header">
            <!-- Logo -->
            <a class="navbar-brand" href="index.html#home">
              <img
                src="assets/img/logo/logo.png"
                alt="Brand Logo"
                style="height: 35px"
              />
            </a>

            <div class="ms-auto"></div>

            <!-- Navbar Nav -->
            <ul class="navbar-nav items mx-auto">
              <li class="nav-item">
                <a class="nav-link" href="index.html#home">Home</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="index.html#features">Features</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="index.html#screenshots"
                  >Screenshots</a
                >
              </li>
              <li class="nav-item">
                <a class="nav-link" href="index.html#pricing">Pricing</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="index.html#contact">Contact</a>
              </li>
            </ul>

            <!-- Navbar Icons -->
            <ul class="navbar-nav icons"></ul>

            <!-- Navbar Toggler -->
            <ul class="navbar-nav toggle">
              <li class="nav-item">
                <a
                  href="#"
                  class="nav-link"
                  data-bs-toggle="modal"
                  data-bs-target="#menu"
                >
                  <i class="icon-menu m-0"></i>
                </a>
              </li>
            </ul>
          </div>
        </nav>
      </header>
      <!-- ***** Header End ***** -->

      <!-- ***** Password Reset Area Start ***** -->
      <section
        id="home"
        class="download subscribe-area has-overlay overlay-gradient vh-100"
      >
        <div class="container h-100">
          <div class="row justify-content-center align-items-center h-100">
            <div class="col-12 col-md-6 col-lg-5">
              <!-- Password Reset Form -->
              <div id="reset-form" style="display: none">
                <h1 class="text-white text-center mb-4">Reset Your Password</h1>
                <p class="text-white text-center mb-4">
                  Please enter your new password below.
                </p>
                <form id="password-reset-form">
                  <div class="mb-3">
                    <input
                      type="password"
                      class="form-control"
                      id="new-password"
                      placeholder="New Password"
                      required
                    />
                  </div>
                  <div class="mb-4">
                    <input
                      type="password"
                      class="form-control"
                      id="confirm-password"
                      placeholder="Confirm New Password"
                      required
                    />
                  </div>
                  <div
                    id="form-error"
                    class="alert alert-danger"
                    style="display: none"
                  ></div>
                  <button
                    type="submit"
                    class="btn btn-primary w-100 mb-3"
                    id="submit-btn"
                  >
                    Reset Password
                  </button>
                </form>
              </div>

              <!-- Success Message -->
              <div id="success-message" style="display: none">
                <h1 class="text-white text-center">
                  Password Reset Successful!
                </h1>
                <p class="text-white text-center">
                  Your password has been successfully reset. You can now go back
                  to the app to log in with your new password.
                </p>
                <div class="text-center mt-4">
                  <a href="index.html#home" class="btn btn-primary"
                    >Go to Home</a
                  >
                </div>
              </div>

              <!-- Error Message -->
              <div id="error-message" style="display: none">
                <h1 class="text-white text-center">Password Reset Failed</h1>
                <p class="text-white text-center" id="error-description">
                  There was an error with your password reset link.
                </p>
                <p class="text-white text-center mt-3">
                  Please request a new password reset link or contact support if
                  the problem persists.
                </p>
                <div class="text-center mt-4">
                  <a href="index.html#home" class="btn btn-primary"
                    >Go to Home</a
                  >
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>
      <!-- ***** Password Reset Area End ***** -->

      <!--====== Modal Responsive Menu Area Start ======-->
      <div id="menu" class="modal fade p-0">
        <div class="modal-dialog modal-dialog-slideout">
          <div class="modal-content full">
            <div class="modal-header" data-bs-dismiss="modal">
              Menu <i class="icon-close"></i>
            </div>
            <div class="menu modal-body">
              <div class="row w-100">
                <div class="items p-0 col-12 text-center">
                  <!-- Append [navbar] -->
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <!--====== Modal Responsive Menu Area End ======-->
    </div>

    <!-- ***** All jQuery Plugins ***** -->

    <!-- jQuery(necessary for all JavaScript plugins) -->
    <script src="assets/js/vendor/jquery.min.js"></script>

    <!-- Bootstrap js -->
    <script src="assets/js/vendor/popper.min.js"></script>
    <script src="assets/js/vendor/bootstrap.min.js"></script>

    <!-- Plugins js -->
    <script src="assets/js/vendor/slider.min.js"></script>
    <script src="assets/js/vendor/owl.carousel.min.js"></script>
    <script src="assets/js/vendor/counterup.js"></script>
    <script src="assets/js/vendor/waypoint.js"></script>
    <script src="assets/js/vendor/aos.js"></script>
    <script src="assets/js/vendor/wow.min.js"></script>
    <script src="assets/js/vendor/gallery.min.js"></script>

    <!-- Main js -->
    <script src="assets/js/main.js"></script>

    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- Config JS -->
    <script src="assets/js/config.js"></script>

    <!-- Reset Password Page Logic -->
    <script>
      (function () {
        const params = new URLSearchParams(window.location.hash.substring(1));
        const accessToken = params.get("access_token");
        const error = params.get("error");
        const errorDescription = params.get("error_description");

        const resetForm = document.getElementById("reset-form");
        const successMsg = document.getElementById("success-message");
        const errorMsg = document.getElementById("error-message");
        const errorDesc = document.getElementById("error-description");
        const passwordForm = document.getElementById("password-reset-form");
        const formError = document.getElementById("form-error");
        const submitBtn = document.getElementById("submit-btn");

        function showError(message) {
          resetForm.style.display = "none";
          successMsg.style.display = "none";
          errorMsg.style.display = "block";
          errorDesc.textContent = message;
        }

        // Handle error case
        if (error) {
          showError(
            errorDescription
              ? decodeURIComponent(errorDescription)
              : "There was an error with your password reset link."
          );
          return;
        }

        // Extract Supabase URL from token
        let supabaseUrl = "";
        if (accessToken) {
          try {
            const payload = JSON.parse(atob(accessToken.split(".")[1]));
            if (payload.iss) {
              supabaseUrl = payload.iss.replace("/auth/v1", "");
            }
          } catch (e) {
            console.error("Failed to extract Supabase URL:", e);
          }
        }

        // Get Supabase anon key (must be set via window.SUPABASE_ANON_KEY)
        const supabaseAnonKey = window.SUPABASE_ANON_KEY;

        // Validate configuration - only check that we have required values
        if (!supabaseUrl || !supabaseAnonKey) {
          showError(
            !supabaseUrl
              ? "Invalid reset token. Please request a new password reset link."
              : "Configuration error. Please contact support."
          );
          return;
        }

        // Initialize Supabase and show form
        const supabase = window.supabase.createClient(
          supabaseUrl,
          supabaseAnonKey
        );

        if (accessToken) {
          resetForm.style.display = "block";
          successMsg.style.display = "none";
          errorMsg.style.display = "none";

          // Set session with access token and handle form submission
          (async () => {
            try {
              const { error: sessionError } = await supabase.auth.setSession({
                access_token: accessToken,
                refresh_token: params.get("refresh_token") || "",
              });

              if (sessionError) {
                showError("Failed to establish session. Please try again.");
                return;
              }

              // Handle form submission - only after session is set
              passwordForm.addEventListener("submit", async (e) => {
                e.preventDefault();

                const newPassword =
                  document.getElementById("new-password").value;
                const confirmPassword =
                  document.getElementById("confirm-password").value;

                // Validate password requirements
                if (newPassword.length < 8) {
                  formError.textContent =
                    "Password must be at least 8 characters long";
                  formError.style.display = "block";
                  return;
                }

                if (!/[A-Z]/.test(newPassword)) {
                  formError.textContent =
                    "Password must contain at least one uppercase letter";
                  formError.style.display = "block";
                  return;
                }

                if (!/[a-z]/.test(newPassword)) {
                  formError.textContent =
                    "Password must contain at least one lowercase letter";
                  formError.style.display = "block";
                  return;
                }

                if (!/\d/.test(newPassword)) {
                  formError.textContent =
                    "Password must contain at least one digit";
                  formError.style.display = "block";
                  return;
                }

                // Validate passwords match
                if (newPassword !== confirmPassword) {
                  formError.textContent = "Passwords do not match";
                  formError.style.display = "block";
                  return;
                }

                formError.style.display = "none";
                submitBtn.disabled = true;
                submitBtn.textContent = "Resetting Password...";

                try {
                  const { error: updateError } = await supabase.auth.updateUser(
                    {
                      password: newPassword,
                    }
                  );

                  if (updateError) throw updateError;

                  resetForm.style.display = "none";
                  successMsg.style.display = "block";
                  errorMsg.style.display = "none";
                } catch (error) {
                  formError.textContent =
                    error.message ||
                    "Failed to reset password. Please try again.";
                  formError.style.display = "block";
                  submitBtn.disabled = false;
                  submitBtn.textContent = "Reset Password";
                }
              });
            } catch (error) {
              showError("Failed to establish session. Please try again.");
            }
          })();
        } else {
          showError("Invalid or missing reset token.");
        }
      })();
    </script>
  </body>
</html>
